---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\Housing_git\nss\Survey_NSS\NSS68\02_NSS68_Residual_Income_Affordability.log
  log type:  text
 opened on:   8 Dec 2020, 10:46:58

. set linesize 255

. 
. ***************************************************************
. *Step 1: Estimate the housing consumption per household member. 
. ***************************************************************
. use "${r_input}\bk_12.dta",clear

. merge m:1 ID using "${r_input}\bk_3.dta"
(label state already defined)
(label B1_v04 already defined)
(label B1_v05 already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         3,562,593  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. gen hh_size = B3_v01

.    
. /* poverty line is by state and by sector */
. 
.     *estimate housing related expenditure:
.           
.           *Rent (12: 26, 30 days recall period)
.           gen double rent = B12_v06*(B12_v01 == 26)

.           
.           *Fuel and light (12: 18, 30 days recall period)
.           gen double fuel = B12_v06*(B12_v01 == 18)

.         
.           *Collapse at household level 
.           foreach var in rent fuel { 
  2.           egen double total_`var' = sum(`var'), by(ID)
  3.           } 

.           bys ID: keep if _n == 1 // keep only one observation for each HH
(3,460,931 observations deleted)

.         
. merge 1:m ID using "${r_input}\bk_10.dta"
(note: variable B1_v00 was byte, now int to accommodate using data's values)
(label B1_v05 already defined)
(label B1_v04 already defined)
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                        33  (_merge==1)
        from using                          0  (_merge==2)

    matched                         2,362,394  (_merge==3)
    -----------------------------------------

. drop _merge

.      
.          *water charge(10: 540, 30 days recall period)
.          keep if B10_v02 == 540
(2,329,875 observations deleted)

.          egen double total_water = sum(B10_v03), by(ID)

.          bys ID: keep if _n == 1 // keep only one observation for each HH
(0 observations deleted)

.         
.         *Total housing expenditure
.         egen double exp_housing = rowtotal(total_rent total_fuel total_water)

. 
.     *Housing consumption per capita
.         gen double total_exp_housing_pp = exp_housing/hh_size

. 
. ******************************************************************************
. *Step 2: Estimate the non-housing expenditure for household at national pline
. ******************************************************************************
. rename ID hhid

. merge 1:1 hhid using "${r_input}\poverty68.dta"
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                        69,110
        from master                         0  (_merge==1)
        from using                     69,110  (_merge==2)

    matched                            32,552  (_merge==3)
    -----------------------------------------

. keep if _merge == 3
(69,110 observations deleted)

. drop _merge

. 
.    gen urban = (B1_v05 == 2) 

.    keep if urban == 1
(13,420 observations deleted)

.    
.    *different budget scenario: pline, double pline, triple pline.    
.    forvalues i = 1/3 {
  2.    gen pline_`i' = pline*`i'
  3.    gen delta_pline_`i' = (abs(mpce_mrp - pline_`i')/pline_`i' * 100 <= 10) //find households around poverty line
  4.    tab delta_pline_`i'
  5.    }

delta_pline |
         _1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     17,869       93.40       93.40
          1 |      1,263        6.60      100.00
------------+-----------------------------------
      Total |     19,132      100.00

delta_pline |
         _2 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     16,681       87.19       87.19
          1 |      2,451       12.81      100.00
------------+-----------------------------------
      Total |     19,132      100.00

delta_pline |
         _3 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     17,071       89.23       89.23
          1 |      2,061       10.77      100.00
------------+-----------------------------------
      Total |     19,132      100.00

.    
.    *Non-housing consumption per capita
.    gen double exp_non_housing_pp = mpce_mrp - total_exp_housing_pp

.    
. save "${r_output}\ria_1.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_1.dta saved

. 
.    *find the median non_housing consumption by state by scenario
.    keep if total_rent > 0 & !mi(total_rent) //using households that paid rent for budget standard
(14,952 observations deleted)

.    forvalues i = 1/3{
  2.    use "${r_output}\ria_1.dta",clear
  3.    
.    keep if delta_pline_`i' == 1 
  4.    egen double exp_non_housing_pp_line_`i' = median(exp_non_housing_pp), by(state)
  5.    
.    bys state: keep if _n == 1
  6.    keep state exp_non_housing_pp_line_`i'
  7.  
.    save "${r_output}\ria_non_housing_line_`i'.dta",replace
  8.    }
(17,869 observations deleted)
(1,230 observations deleted)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line_1.dta saved
(16,681 observations deleted)
(2,417 observations deleted)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line_2.dta saved
(17,071 observations deleted)
(2,030 observations deleted)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line_3.dta saved

.    
.    use "${r_output}\ria_non_housing_line_1.dta",clear

.    forvalues i = 2/3{
  2.    merge 1:1 state using "${r_output}\ria_non_housing_line_`i'.dta"
  3.    drop _merge
  4.    }
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    matched                                33  (_merge==3)
    -----------------------------------------
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             3
        from master                         3  (_merge==1)
        from using                          0  (_merge==2)

    matched                                31  (_merge==3)
    -----------------------------------------

.    
. save "${r_output}\ria_non_housing_line.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line.dta saved

.    
. merge 1:m state using "${r_output}\ria_1.dta"
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                            19,132  (_merge==3)
    -----------------------------------------

. keep if _merge == 3 //only on urban sector
(0 observations deleted)

. drop _merge  

. 
.         *find the affordable housings
.         forvalues i = 1/3 {
  2.     gen affordable_`i' = (exp_non_housing_pp > exp_non_housing_pp_line_`i')*100
  3.     tab affordable_`i' [aw = hhwt]
  4.     }

affordable_ |
          1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 1,463.0974        7.65        7.65
        100 |17,668.9026       92.35      100.00
------------+-----------------------------------
      Total |     19,132      100.00

affordable_ |
          2 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 8,764.6168       45.81       45.81
        100 | 10,367.383       54.19      100.00
------------+-----------------------------------
      Total |     19,132      100.00

affordable_ |
          3 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 13,578.963       70.98       70.98
        100 |5,553.03678       29.02      100.00
------------+-----------------------------------
      Total |     19,132      100.00

.         
. save "${r_output}\ria_final.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_final.dta saved

. 
. ******************************************************************************
. *Step 3: stats by consumption quintile 
. ******************************************************************************
. use "${r_output}\ria_final.dta",clear

. 
. * the affordability by quintile. 
. xtile mpce_qt = mpce_mrp [aw = hhwt] , n(5)

. global var_tab_1 "affordable_1 affordable_2 affordable_3"

. 
. qui eststo total : estpost summarize $var_tab_1 [aw = hhwt],de

. forvalues i = 1/5 {
  2. qui eststo q`i' : estpost summarize $var_tab_1 [aw = hhwt] if mpce_qt == `i',de
  3. }

. esttab total q1 q2 q3 q4 q5, cells(mean(fmt(%15.0fc))) label collabels(none) ///
>  mtitles("All" "Q1" "Q2" "Q3" "Q4" "Q5") stats(N, label("Observations") fmt(%15.0gc)) /// 
>  title("Table 1. Share of Households Living in Affordable Houses by Consumption Expenditure Quintile in Urban India (2012)") varwidth(40) ///
>  addnote("Notes: Households weighted by survey weights." ///
>  "       The analysis is using the Residual Income Approach." ///
>  "       The affordable_1 is estimated using renters' non-housing expenses drawn from India's urban national poverty threshold by state as the budget standard." ///
>  "       The affordable_2 and affordable_3 are estimated utilizing the similar approach but with the double and triple poverty thresholds."
) required
r(100);

end of do-file

r(100);

