----------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\Housing_git\nss\Survey_NSS\NSS68\02_NSS68_Residual_Income_Affordability.log
  log type:  text
 opened on:   3 Dec 2020, 03:21:35

. set linesize 255

. 
. ***************************************************************
. *Step 1: Estimate the housing consumption per household member. 
. ***************************************************************
. use "${r_input}\bk_12.dta",clear

. merge m:1 ID using "${r_input}\bk_3.dta"
(label state already defined)
(label B1_v04 already defined)
(label B1_v05 already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         3,562,593  (_merge==3)
    -----------------------------------------

. 
. gen hh_size = B3_v01

.    
. /* poverty line is by state and by sector */
. 
.     *estimate housing related expenditure:
.           *?water charge (10:540)
.           
.           *Rent (12: 26, 30 days recall period)
.           gen double rent = B12_v06*(B12_v01 == 26)

.           
.           *Fuel and light (12: 18, 30 days recall period)
.           gen double fuel = B12_v06*(B12_v01 == 18)

.       
.         *Total housing expenditure
.         egen double exp_housing = rowtotal(rent fuel)

.         
.         *Collapse at household level 
.         foreach var in rent fuel exp_housing { 
  2.         egen double total_`var' = sum(`var'), by(ID)
  3.         } 

.         bys ID: keep if _n == 1 // keep only one observation for each HH
(3,460,931 observations deleted)

.     
.         *Housing consumption per capita
.         gen double total_exp_housing_pp = total_exp_housing/hh_size

. 
. rename ID hhid

. drop _merge

. 
. ******************************************************************************
. *Step 2: Estimate the non-housing expenditure for household at national pline
. ******************************************************************************
. merge 1:1 hhid using "${r_input}\poverty68.dta"
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           101,662  (_merge==3)
    -----------------------------------------

. keep if _merge == 3
(0 observations deleted)

. drop _merge

. 
.    gen urban = (B1_v05 == 2) 

.    keep if urban == 1
(59,695 observations deleted)

.    
.    *different budget scenario: pline, double pline, triple pline.    
.    forvalues i = 1/3 {
  2.    gen pline_`i' = pline*`i'
  3.    gen delta_pline_`i' = (abs(mpce_mrp - pline_`i')/pline_`i' * 100 <= 10) //find households around poverty line
  4.    tab delta_pline_`i'
  5.    }

delta_pline |
         _1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     38,423       91.56       91.56
          1 |      3,544        8.44      100.00
------------+-----------------------------------
      Total |     41,967      100.00

delta_pline |
         _2 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     37,151       88.52       88.52
          1 |      4,816       11.48      100.00
------------+-----------------------------------
      Total |     41,967      100.00

delta_pline |
         _3 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |     37,940       90.40       90.40
          1 |      4,027        9.60      100.00
------------+-----------------------------------
      Total |     41,967      100.00

.    
.    *Non-housing consumption per capita
.    gen double exp_non_housing_pp = mpce_mrp - total_exp_housing_pp

.    
. save "${r_output}\ria_1.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_1.dta saved

. 
.    *find the median non_housing consumption by state by scenario
.    forvalues i = 1/3{
  2.    use "${r_output}\ria_1.dta",clear
  3.    
.    keep if delta_pline_`i' == 1 
  4.    egen double exp_non_housing_pp_line_`i' = median(exp_non_housing_pp), by(state)
  5.    
.    bys state: keep if _n == 1
  6.    keep state exp_non_housing_pp_line_`i'
  7.  
.    save "${r_output}\ria_non_housing_line_`i'.dta",replace
  8.    }
(38,423 observations deleted)
(3,510 observations deleted)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line_1.dta saved
(37,151 observations deleted)
(4,781 observations deleted)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line_2.dta saved
(37,940 observations deleted)
(3,992 observations deleted)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line_3.dta saved

.    
.    use "${r_output}\ria_non_housing_line_1.dta",clear

.    forvalues i = 2/3{
  2.    merge 1:1 state using "${r_output}\ria_non_housing_line_`i'.dta"
  3.    drop _merge
  4.    }
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    matched                                34  (_merge==3)
    -----------------------------------------
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                35  (_merge==3)
    -----------------------------------------

.    
. save "${r_output}\ria_non_housing_line.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line.dta saved

.    
. merge 1:m state using "${r_output}\ria_1.dta"
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                            41,967  (_merge==3)
    -----------------------------------------

. keep if _merge == 3 //only on urban sector
(0 observations deleted)

. drop _merge  

. 
.         *find the affordable housings
.         forvalues i = 1/3 {
  2.     gen affordable_`i' = (exp_non_housing_pp > exp_non_housing_pp_line_`i')*100
  3.     tab affordable_`i' [aw = hhwt]
  4.     }

affordable_ |
          1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |  4,334.624       10.33       10.33
        100 | 37,632.376       89.67      100.00
------------+-----------------------------------
      Total |     41,967      100.00

affordable_ |
          2 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 20,457.892       48.75       48.75
        100 | 21,509.108       51.25      100.00
------------+-----------------------------------
      Total |     41,967      100.00

affordable_ |
          3 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |   30,472.9       72.61       72.61
        100 |   11,494.1       27.39      100.00
------------+-----------------------------------
      Total |     41,967      100.00

.         
. save "${r_output}\ria_final.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_final.dta saved

. 
. ******************************************************************************
. *Step 3: stats by consumption quintile 
. ******************************************************************************
. use "${r_output}\ria_final.dta",clear

. 
. xtile mpce_qt = mpce_mrp [aw = hhwt] , n(5)

. global var_tab_1 "affordable_1 affordable_2 affordable_3"

. 
. qui eststo total : estpost summarize $var_tab_1 [aw = hhwt],de

. forvalues i = 1/5 {
  2. qui eststo q`i' : estpost summarize $var_tab_1 [aw = hhwt] if mpce_qt == `i',de
  3. }

. esttab total q1 q2 q3 q4 q5, cells(mean(fmt(%15.0fc))) label collabels(none) ///
>  mtitles("All" "Q1" "Q2" "Q3" "Q4" "Q5") stats(N, label("Observations") fmt(%15.0gc)) /// 
>  title("Table 1. Share of Households Living in Affordable Houses by Consumption Expenditure Quintile in Urban India") varwidth(40) ///
>  addnote("Notes: Households weighted by survey weights." ///
>  "       The analysis is using the Residual Income Approach." ///
>  "       The affordable_1 is estimated using non-housing expenses drawn from India's urban national poverty threshold by state." ///
>  "       The affordable_2 and affordable_3 are estimated utilizing the similar approach but with the double and triple poverty thresholds.")

Table 1. Share of Households Living in Affordable Houses by Consumption Expenditure Quintile in Urban India
----------------------------------------------------------------------------------------------------------------------
                                                  (1)          (2)          (3)          (4)          (5)          (6)
                                                  All           Q1           Q2           Q3           Q4           Q5
----------------------------------------------------------------------------------------------------------------------
affordable_1                                       90           50           99          100          100          100
affordable_2                                       51            0            3           58           95          100
affordable_3                                       27            0            0            0           40           97
----------------------------------------------------------------------------------------------------------------------
Observations                                   41,967       10,559        8,194        7,642        7,790        7,782
----------------------------------------------------------------------------------------------------------------------
Notes: Households weighted by survey weights.
       The analysis is using the Residual Income Approach.
       The affordable_1 is estimated using non-housing expenses drawn from India's urban national poverty threshold by state.
       The affordable_2 and affordable_3 are estimated utilizing the similar approach but with the double and triple poverty thresholds.

. 
. table mpce_qt [aw = hhwt],c(mean affordable_1 mean affordable_2 mean affordable_3)

----------------------------------------------------------
5         |
quantiles |
of        |
mpce_mrp  | mean(afford~1)  mean(afford~2)  mean(afford~3)
----------+-----------------------------------------------
        1 |         50.029               0               0
        2 |       98.56569        2.736293               0
        3 |       99.93748        58.42352        .2862832
        4 |       99.93434        95.12606        40.15673
        5 |        99.8936        99.98193        96.50821
----------------------------------------------------------

. 
end of do-file

. exit, clear
