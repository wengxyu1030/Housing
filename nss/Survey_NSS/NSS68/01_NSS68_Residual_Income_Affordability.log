---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\Housing_git\nss\Survey_NSS\NSS68\01_NSS68_Residual_Income_Affordability.log
  log type:  text
 opened on:  25 Jan 2021, 07:24:43

. set linesize 255

. 
. ***************************************************************
. *Step 1: Estimate the housing consumption per household member. 
. ***************************************************************
. use "${r_input}\bk_12.dta",clear

. merge m:1 ID using "${r_input}\bk_3.dta"
(label state already defined)
(label B1_v04 already defined)
(label B1_v05 already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                         3,562,593  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. gen hh_size = B3_v01

.    
. /* poverty line is by state and by sector */
. 
.     *estimate housing related expenditure:
.           
.           *Rent (12: 26, 30 days recall period)
.           gen double rent = B12_v06*(B12_v01 == 26)

.           
.           *Fuel and light (12: 18, 30 days recall period)
.           gen double fuel = B12_v06*(B12_v01 == 18)

.         
.           *Collapse at household level 
.           foreach var in rent fuel { 
  2.           egen double total_`var' = sum(`var'), by(ID)
  3.           } 

.           bys ID: keep if _n == 1 // keep only one observation for each HH
(3,460,931 observations deleted)

.         
.       merge 1:m ID using "${r_input}\bk_10.dta"
(note: variable B1_v00 was byte, now int to accommodate using data's values)
(label B1_v05 already defined)
(label B1_v04 already defined)
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                        33  (_merge==1)
        from using                          0  (_merge==2)

    matched                         2,362,394  (_merge==3)
    -----------------------------------------

.       drop _merge

.      
.           *water charge(10: 540, 30 days recall period)
.           keep if B10_v02 == 540
(2,329,875 observations deleted)

.           egen double total_water = sum(B10_v03), by(ID)

.           bys ID: keep if _n == 1 // keep only one observation for each HH
(0 observations deleted)

.         
.         *Total housing expenditure
.         egen double exp_housing = rowtotal(total_rent total_fuel total_water)

. 
.     *Housing consumption per capita
.         gen double total_exp_housing_pp = exp_housing/hh_size 

.         
.     *Identify renters
.         gen renter = (total_rent > 0 & !mi(total_rent)) & B3_v18 == 2 //rent is positive and tenure status is hire. 

. 
. ******************************************************************************
. *Step 2: Estimate the non-housing expenditure for household at national pline
. ******************************************************************************
. rename ID hhid

. merge 1:1 hhid using "${r_input}\poverty68.dta"
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                        69,110
        from master                         0  (_merge==1)
        from using                     69,110  (_merge==2)

    matched                            32,552  (_merge==3)
    -----------------------------------------

. keep if _merge == 3
(69,110 observations deleted)

. drop _merge

.    
.    *different budget scenario: pline, double pline, triple pline.    
.    forvalues i = 1/3 {
  2.    gen pline_`i' = pline*`i'
  3.    }

.    
.    *Non-housing consumption per capita
.    gen double exp_non_housing_pp = mpce_mrp - total_exp_housing_pp //all poverty line data are compiled using the MRP metho

.    
.    *Expenditure quintile (for all india, urban and rural sector)
.    xtile mpce_qt = mpce_mrp [aw = hhwt] , n(5)

.    xtile mpce_qt_tn = mpce_mrp [aw = hhwt] if state == 33, n(5)

.    
.    *take log of expenditure
.    gen mpce_mrp_ln = ln(mpce_mrp)

.    
.    *keep urban household only
.    gen urban = (B1_v05 == 2) 

.    keep if urban == 1 //only focusing on urban households
(13,420 observations deleted)

.    
. save "${r_output}\ria_1.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_1.dta saved

. 
. //get the poverty line by state for the urban sector
. use "${r_output}\ria_1.dta",replace

. 
. keep if urban == 1
(0 observations deleted)

. gen state_n = state

. 
. collapse (mean) pline_1 pline_2 pline_3,by(state state_n) 

. gen _Istate_ = 1

. 
. reshape wide _Istate_,i(state pline_1 pline_2 pline_3) j(state_n)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 32 33 34 35)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                       34   ->      34
Number of variables                   6   ->      38
j variable (34 values)          state_n   ->   (dropped)
xij variables:
                               _Istate_   ->   _Istate_1 _Istate_2 ... _Istate_35
-----------------------------------------------------------------------------

. qui mvencode _all, mv(0) //change missing values to zero

. 
. reshape long pline_,i(state) j(levels)
(note: j = 1 2 3)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                       34   ->     102
Number of variables                  38   ->      37
j variable (3 values)                     ->   levels
xij variables:
                pline_1 pline_2 pline_3   ->   pline_
-----------------------------------------------------------------------------

. 
. rename pline mpce_mrp

. gen exp_non_housing_pp = . 
(102 missing values generated)

. 
. save "${r_output}\temp.dta",replace
(note: file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\temp.dta not found)
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\temp.dta saved

. 
. //fit renter's non-housing and total expenditure to linear model
. use "${r_output}\ria_1.dta",replace

. gen state_r = state 

. 
. drop if renter != 1 //only focusing on renters. 
(15,584 observations deleted)

. xi: reg exp_non_housing_pp mpce_mrp i.state, noconstant
i.state           _Istate_1-35        (naturally coded; _Istate_1 omitted)

      Source |       SS           df       MS      Number of obs   =     3,548
-------------+----------------------------------   F(34, 3514)     =   4069.51
       Model |  4.8313e+10        34  1.4210e+09   Prob > F        =    0.0000
    Residual |  1.2270e+09     3,514  349174.579   R-squared       =    0.9752
-------------+----------------------------------   Adj R-squared   =    0.9750
       Total |  4.9540e+10     3,548    13962772   Root MSE        =    590.91

------------------------------------------------------------------------------
exp_non_ho~p |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mpce_mrp |   .7919916    .003292   240.58   0.000     .7855371    .7984461
   _Istate_2 |   165.7975   66.93024     2.48   0.013     34.57141    297.0235
   _Istate_3 |  -101.0209   71.41758    -1.41   0.157    -241.0451    39.00318
   _Istate_4 |  -295.5812   56.02539    -5.28   0.000    -405.4268   -185.7356
   _Istate_5 |  -117.6528   55.45951    -2.12   0.034    -226.3889   -8.916683
   _Istate_6 |  -500.0579   61.74271    -8.10   0.000    -621.1131   -379.0027
   _Istate_7 |  -624.1917   52.60623   -11.87   0.000    -727.3335   -521.0498
   _Istate_8 |  -75.84134   39.37088    -1.93   0.054    -153.0334    1.350754
   _Istate_9 |   67.90032   57.29885     1.19   0.236    -44.44206    180.2427
  _Istate_10 |  -411.2096   341.2915    -1.20   0.228    -1080.359    257.9399
  _Istate_11 |  -376.3869   223.6123    -1.68   0.092    -814.8099    62.03604
  _Istate_12 |   35.56917   47.41372     0.75   0.453    -57.39203    128.5304
  _Istate_13 |  -34.62849   110.0909    -0.31   0.753     -250.477    181.2201
  _Istate_14 |    -226.69   264.3821    -0.86   0.391     -745.048     291.668
  _Istate_15 |  -50.63976   56.67725    -0.89   0.372    -161.7634    60.48389
  _Istate_16 |  -348.0289   295.6125    -1.18   0.239    -927.6185    231.5606
  _Istate_17 |  -35.44924   135.7607    -0.26   0.794     -301.627    230.7285
  _Istate_18 |  -72.36109   132.8916    -0.54   0.586    -332.9137    188.1915
  _Istate_19 |   92.35422   148.2253     0.62   0.533    -198.2622    382.9706
  _Istate_20 |  -94.13179   74.99715    -1.26   0.210    -241.1741    52.91058
  _Istate_21 |  -176.3068   66.79307    -2.64   0.008    -307.2639   -45.34969
  _Istate_22 |   37.84141   86.63506     0.44   0.662    -132.0187    207.7015
  _Istate_23 |  -43.78944    54.0002    -0.81   0.417    -149.6644    62.08549
  _Istate_24 |  -26.11593    84.1242    -0.31   0.756    -191.0531    138.8213
  _Istate_25 |   137.4139   341.3399     0.40   0.687    -531.8305    806.6584
  _Istate_26 |    166.792   590.9856     0.28   0.778    -991.9177    1325.502
  _Istate_27 |  -155.2258   34.02983    -4.56   0.000     -221.946   -88.50558
  _Istate_28 |  -190.9304   31.69338    -6.02   0.000    -253.0697   -128.7911
  _Istate_29 |  -199.0193   30.73481    -6.48   0.000    -259.2792   -138.7594
  _Istate_30 |  -99.10796   85.97352    -1.15   0.249     -267.671     69.4551
  _Istate_32 |  -231.3264   65.95236    -3.51   0.000    -360.6352   -102.0177
  _Istate_33 |  -76.15346   35.20342    -2.16   0.031    -145.1747   -7.132251
  _Istate_34 |  -83.14266    58.8351    -1.41   0.158    -198.4971    32.21175
  _Istate_35 |   11.43011   113.3002     0.10   0.920    -210.7106    233.5709
------------------------------------------------------------------------------

. 
. //estimate the non-housing expenditure budget standard (non-housing expenditure poverty line)
. use "${r_output}\temp.dta",clear

. predict exp_non_housing_pp_line_
(option xb assumed; fitted values)

. 
. rename mpce_mrp pline_

. keep state levels pline exp_non_housing_pp_line_

. reshape wide pline exp_non_housing_pp_line_, i(state) j(level)
(note: j = 1 2 3)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      102   ->      34
Number of variables                   4   ->       7
j variable (3 values)            levels   ->   (dropped)
xij variables:
                                 pline_   ->   pline_1 pline_2 pline_3
               exp_non_housing_pp_line_   ->   exp_non_housing_pp_line_1 exp_non_housing_pp_line_2 exp_non_housing_pp_line_3
-----------------------------------------------------------------------------

. 
. save "${r_output}\ria_non_housing_line.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_non_housing_line.dta saved

. erase "${r_output}\temp.dta"

. 
. //merge the alternative poverty lines to the master data.    
. merge 1:m state using "${r_output}\ria_1.dta"
(label state already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                            19,132  (_merge==3)
    -----------------------------------------

. 
. keep if _merge == 3 //only on urban sector
(0 observations deleted)

. drop _merge  

. drop if total_rent == 0 & !mi(total_rent) //only focusing on renters. 
(14,952 observations deleted)

. 
.         *find the affordable housings
.         forvalues i = 1/3 {
  2.     gen affordable_`i' = (exp_non_housing_pp > exp_non_housing_pp_line_`i')*100
  3.     tab affordable_`i' [aw = hhwt]
  4.         
.         gen unaffordable_`i' = (affordable_`i' == 0)*100
  5.     }

affordable_ |
          1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 70.8848952        1.70        1.70
        100 | 4,109.1151       98.30      100.00
------------+-----------------------------------
      Total |      4,180      100.00

affordable_ |
          2 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |924.7639175       22.12       22.12
        100 | 3,255.2361       77.88      100.00
------------+-----------------------------------
      Total |      4,180      100.00

affordable_ |
          3 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 2,179.0837       52.13       52.13
        100 | 2,000.9163       47.87      100.00
------------+-----------------------------------
      Total |      4,180      100.00

. 
. // hosue keeping
. forvalues i = 1/3 {
  2. label var unaffordable_`i' "Hs. in Unaffordable Housing `i'pline"
  3. label var affordable_`i' "Hs. in Affordable Housing `i'pline"
  4. }

. 
. label var exp_non_housing_pp "Mth. PC. Non-Housing Exp."

. label var total_exp_housing_pp "Mth. PC. Housing Exp."

. 
. save "${r_output}\ria_final.dta",replace
file C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\nss_data\NSS68\Data Output Files\ria_final.dta saved

. 
. ******************************************************************************
. *Step 3: stats by consumption quintile 
. ******************************************************************************
.  
. * distribution of owner and renter consumption expenditure in urban area: renters are in higher quintiles. 
. use "${r_output}\ria_1.dta",clear //with both renter and owner. 

. 
. twoway kdensity mpce_mrp_ln [aw = hhwt] if renter == 1 || kdensity mpce_mrp_ln [aw = hhwt] if renter == 0, ///
> legend(order(1 "Renter" 2 "Owner")) title("Table 2. Kdensity of Log Monthly per capita Consumer Expenditure (MPCE) for India Urban Household (2012)", size(tiny)) xtitle("Log MPCE") ytitle("Kdensity")

. 
. gen tn = (state == 33)

.  
. table renter, c(mean mpce_mrp median mpce_mrp) format(%9.2f) row

------------------------------------------
   renter | mean(mpce_mrp)   med(mpce_mrp)
----------+-------------------------------
        0 |        2694.97         2096.20
        1 |        3680.52         2912.35
          | 
    Total |        2877.74         2245.84
------------------------------------------

. table mpce_qt, c(mean renter) format(%9.2f) row

------------------------
5         |
quantiles |
of        |
mpce_mrp  | mean(renter)
----------+-------------
        1 |         0.08
        2 |         0.12
        3 |         0.13
        4 |         0.21
        5 |         0.27
          | 
    Total |         0.19
------------------------

. 
. table renter if tn == 1, c(mean mpce_mrp median mpce_mrp) format(%9.2f)row

------------------------------------------
   renter | mean(mpce_mrp)   med(mpce_mrp)
----------+-------------------------------
        0 |        2822.20         2320.82
        1 |        3565.60         2784.98
          | 
    Total |        2993.34         2435.74
------------------------------------------

. table mpce_qt_tn if tn == 1, c(mean renter) format(%9.2f) row

------------------------
5         |
quantiles |
of        |
mpce_mrp  | mean(renter)
----------+-------------
        1 |         0.11
        2 |         0.20
        3 |         0.20
        4 |         0.28
        5 |         0.28
          | 
    Total |         0.23
------------------------

. 
. *affordability and the share of housing expenditure to total expenditure (RIA and Ratio Approach)
. use "${r_output}\ria_final.dta",replace

. 
. //total expenditure on housing/total expenditure 
. gen h_t_exp_mn = total_exp_housing_pp/mpce_mrp*100 

. label var h_t_exp_mn "Mean of Housing Exp. / Total Exp. (%)"

. 
. egen h_t_exp_r_md_q = median(h_t_exp_mn),by(mpce_qt)

. egen h_t_exp_r_md_all = median(h_t_exp_mn)

. 
. egen h_t_exp_r_md_q_tn = median(h_t_exp_mn) if state == 33,by(mpce_qt_tn)
(3862 missing values generated)

. egen h_t_exp_r_md_all_tn = median(h_t_exp_mn) if state == 33
(3862 missing values generated)

. 
. foreach var in h_t_exp_r_md_all {
  2. label var `var' "Med.of Housing Exp. / Total Exp. (%)" 
  3. label var `var'_tn "Med.of Housing Exp. / Total Exp. (%)" 
  4. }

. 
. //poverty rate (national)
. replace poor = poor*100
(198 real changes made)

. label var poor "Poverty Rate (%)"

. 
. //table of affordability by quintile
. global var_tab_1 "h_t_exp_mn unaffordable_1 unaffordable_2 unaffordable_3 poor"

. 
. qui eststo total : estpost summarize h_t_exp_r_md_all $var_tab_1 [aw = hhwt],de

. replace h_t_exp_r_md_all = h_t_exp_r_md_q 
(4,180 real changes made)

. 
. qui eststo total_tn : estpost summarize h_t_exp_r_md_all_tn $var_tab_1 [aw = hhwt] if state == 33,de

. replace h_t_exp_r_md_all_tn = h_t_exp_r_md_q_tn
(318 real changes made)

. 
. forvalues i = 1/5 {
  2. qui eststo q`i' : estpost summarize h_t_exp_r_md_all $var_tab_1 [aw = hhwt] if mpce_qt == `i',de
  3. qui eststo q`i'_tn : estpost summarize h_t_exp_r_md_all_tn $var_tab_1 [aw = hhwt] if mpce_qt_tn == `i' & state == 33,de
  4. }

. 
. //table for all India
. esttab total q1 q2 q3 q4 q5, cells(mean(fmt(%15.1fc))) label collabels(none) /// 
>  mtitles("All" "Q1" "Q2" "Q3" "Q4" "Q5") stats(N, label("Observations") fmt(%15.0gc)) /// 
>  title("Table 1. Percent of Renter Households with Unaffordable Housing Expenditure by Expenditure Quintile in Urban India (2012)") varwidth(40) ///
>  addnote("Notes: The data source is NSS 68th Round Household Consumer Expenditure." ///
>  "       Households weighted by survey weights." ///
>  "       The analysis is using the Residual Income Approach." ///
>  "       The affordability at 1pline is estimated using renters' non-housing expenses drawn from India's urban national poverty threshold by state as the budget standard." ///
>  "       The affordabiiity at 2pline and 3pline are estimated utilizing the similar approach but with the double and triple poverty thresholds." ///
>  "       Renters are identified as households paying positive rent." ///
>  "       The owner non-housing consumer expenditure is not in the scope as the mortgage payment data is not collected in the the survey.")

Table 1. Percent of Renter Households with Unaffordable Housing Expenditure by Expenditure Quintile in Urban India (2012)
----------------------------------------------------------------------------------------------------------------------
                                                  (1)          (2)          (3)          (4)          (5)          (6)
                                                  All           Q1           Q2           Q3           Q4           Q5
----------------------------------------------------------------------------------------------------------------------
Med.of Housing Exp. / Total Exp. (%)             22.2         22.2         22.8         21.1         22.1         22.4
Mean of Housing Exp. / Total Exp. (%)            24.9         23.4         25.1         23.0         25.0         25.3
Hs. in Unaffordable Housing 1pline                1.7         45.5          1.0          0.0          0.0          0.0
Hs. in Unaffordable Housing 2pline               22.1        100.0         99.1         66.8         12.8          0.1
Hs. in Unaffordable Housing 3pline               52.1        100.0        100.0        100.0         89.6         10.7
Poverty Rate (%)                                  2.3         63.7          0.2          0.0          0.0          0.0
----------------------------------------------------------------------------------------------------------------------
Observations                                    4,180          272          367          521        1,109        1,911
----------------------------------------------------------------------------------------------------------------------
Notes: The data source is NSS 68th Round Household Consumer Expenditure.
       Households weighted by survey weights.
       The analysis is using the Residual Income Approach.
       The affordability at 1pline is estimated using renters' non-housing expenses drawn from India's urban national poverty threshold by state as the budget standard.
       The affordabiiity at 2pline and 3pline are estimated utilizing the similar approach but with the double and triple poverty thresholds.
       Renters are identified as households paying positive rent.
       The owner non-housing consumer expenditure is not in the scope as the mortgage payment data is not collected in the the survey.

. 
. //table for TN: higher affordability than india. 
. esttab total_tn q1_tn q2_tn q3_tn q4_tn q5_tn, cells(mean(fmt(%15.1fc))) label collabels(none) /// 
>  mtitles("All" "Q1" "Q2" "Q3" "Q4" "Q5") stats(N, label("Observations") fmt(%15.0gc)) /// 
>  title("Table 2. Percent of Renter Households with Unaffordable Housing Expenditure by Expenditure Quintile in Urban Tamil Nadu (2012)") varwidth(40) ///
>  addnote("Notes: The data source is NSS 68th Round Household Consumer Expenditure." ///
>  "       Households weighted by survey weights." ///
>  "       The analysis is using the Residual Income Approach." ///
>  "       The affordability at 1pline is estimated using renters' non-housing expenses drawn from India's urban national poverty threshold by state as the budget standard." ///
>  "       The affordabiiity at 2pline and 3pline are estimated utilizing the similar approach but with the double and triple poverty thresholds." ///
>  "       Renters are identified as households paying positive rent." ///
>  "       The owner non-housing consumer expenditure is not in the scope as the mortgage payment data is not collected in the the survey.")

Table 2. Percent of Renter Households with Unaffordable Housing Expenditure by Expenditure Quintile in Urban Tamil Nadu (2012)
----------------------------------------------------------------------------------------------------------------------
                                                  (1)          (2)          (3)          (4)          (5)          (6)
                                                  All           Q1           Q2           Q3           Q4           Q5
----------------------------------------------------------------------------------------------------------------------
Med.of Housing Exp. / Total Exp. (%)             23.3         23.8         23.5         23.9         24.7         22.0
Mean of Housing Exp. / Total Exp. (%)            24.6         25.6         22.5         26.6         25.5         23.4
Hs. in Unaffordable Housing 1pline                1.7         39.5          0.0          0.0          0.0          0.0
Hs. in Unaffordable Housing 2pline               25.1        100.0         92.2         46.4          1.8          0.0
Hs. in Unaffordable Housing 3pline               52.0        100.0        100.0        100.0         54.9          0.4
Poverty Rate (%)                                  1.6         35.5          0.0          0.0          0.0          0.0
----------------------------------------------------------------------------------------------------------------------
Observations                                      318           23           35           51           95          114
----------------------------------------------------------------------------------------------------------------------
Notes: The data source is NSS 68th Round Household Consumer Expenditure.
       Households weighted by survey weights.
       The analysis is using the Residual Income Approach.
       The affordability at 1pline is estimated using renters' non-housing expenses drawn from India's urban national poverty threshold by state as the budget standard.
       The affordabiiity at 2pline and 3pline are estimated utilizing the similar approach but with the double and triple poverty thresholds.
       Renters are identified as households paying positive rent.
       The owner non-housing consumer expenditure is not in the scope as the mortgage payment data is not collected in the the survey.

. 
. * k-density for affordability: housing/expenditure around. 
. gen exp_non_housing_pp_ln = ln(exp_non_housing_pp)

. 
. sum pline_1 pline_2 pline_3 if state == 33

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
     pline_1 |        318         937           0        937        937
     pline_2 |        318        1874           0       1874       1874
     pline_3 |        318        2811           0       2811       2811

. 
. forvalues i = 1/3 {
  2. qui sum pline_`i' if state == 33
  3. local pline_`i'_ln = ln(r(mean))
  4. dis `pline_`i'_ln'
  5. }
6.8426833
7.5358305
7.9412956

. 
. kdensity exp_non_housing_pp_ln if state == 33 [aw=hhwt], xline(`pline_1_ln' `pline_2_ln' `pline_3_ln') ///
> title("NSS68 - 2012, Residual Income vs. Minimum Standard by Scenario in Urban Tamil Nadu", size(small)) ///
> xtitle("Ln of Non-housing Exp. PC.")

.  
. log close
      name:  <unnamed>
       log:  C:\Users\wb500886\OneDrive - WBG\7_Housing\survey_all\Housing_git\nss\Survey_NSS\NSS68\01_NSS68_Residual_Income_Affordability.log
  log type:  text
 closed on:  25 Jan 2021, 07:25:05
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
